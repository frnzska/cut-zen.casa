AWSTemplateFormatVersion: 2010-09-09

Parameters:
  DomainName:
    Type: String

Resources:
  DNS:
    Type: "AWS::Route53::HostedZone"
    Properties:
      HostedZoneConfig:
        Comment: !Sub Hosted zone for "${DomainName}"
      Name: !Ref DomainName
  DNSEntries:
    DependsOn: DNS
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneName: !Sub '${DomainName}.'
      RecordSets:
        - AliasTarget:
            HostedZoneId: Z1BKCTXD74EZPE # for s3 location in Region Ireland TODO mapping region->id
            # see https://docs.aws.amazon.com/general/latest/gr/s3.html#s3_website_region_endpoints
            DNSName: !Join ['', ['s3-website-', !Ref 'AWS::Region', '.amazonaws.com']]
            # later cloudfront distro
            # DNSName: !GetAtt
            #            - myCloudFrontDistribution
            #            - DomainName
          Name: !Ref DomainName
          Type: A

  CFDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: 'true'
        Logging:
          IncludeCookies: 'false'
          Bucket: !Sub 'logs.${DomainName}'
          Prefix: cloudfront
        Aliases:
          - !Ref DomainName
          - !Sub 'www.${DomainName}'
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
        TargetOriginId: S3Origin
        ViewerProtocolPolicy: "redirect-to-https"
        Origins:
        - Id: "S3Origin"
          DomainName: !Sub ${DomainName}-website.s3.amazonaws.com
          S3OriginConfig:
            OriginAccessIdentity: # Todo!Join [ "", [ "origin-access-identity/cloudfront/", !Ref OriginAccessIdentity ] ]
            # maybe do later
        ViewerCertificate:
          AcmCertificateArn: #TODO cross stack ref
          MinimumProtocolVersion: "TLSv1.2_2018"
          SslSupportMethod: "sni-only"
